<!DOCTYPE html>
<html lang="nl">
<head>
    <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <script>
        (function(){
            try {
                const v = Date.now();
                document.addEventListener('DOMContentLoaded', function(){
                    // Bust CSS caches
                    document.querySelectorAll('link[rel="stylesheet"][href]').forEach(function(link){
                        const href = link.getAttribute('href');
                        if (href && href.indexOf('?') === -1) { link.href = href + '?v=' + v; }
                    });
                    // Bust JS caches
                    document.querySelectorAll('script[src]').forEach(function(s){
                        const src = s.getAttribute('src');
                        if (src && src.indexOf('?') === -1) { s.src = src + '?v=' + v; }
                    });
                });
            } catch(e) { /* no-op */ }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneel - Mister</title>
    <link rel="stylesheet" href="css/style.css?v=20251104-1">
    <script src="js/gh-dispatch.js"></script>
    <style>
        body { background: #181828; color: #e3e6f0; font-family: 'Inter', sans-serif; }
        .admin-container { max-width: 480px; margin: 0 auto; padding: 32px 12px; }
        .admin-card { background: #23234a; border-radius: var(--card-radius, 16px); box-shadow: var(--card-shadow, 0 8px 32px #0002); padding: 28px 20px; margin-bottom: 24px; position: relative; border: var(--card-border-w, 3px) solid var(--card-border-color, #7c3aed); }
        .admin-title { font-size: 1.5em; font-weight: 700; margin-bottom: 18px; color: #e3e6f0; }
        .admin-section { margin-bottom: 32px; }
        .admin-label { font-weight: 600; margin-bottom: 6px; display: block; }
        .admin-input, .admin-textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #333; background: #181828; color: #e3e6f0; margin-bottom: 12px; }
        /* Knoppen volgen nu de globale donkere admin-stijl (rectangular) uit css/style.css */
        .admin-btn { background: #0f0f1a; border: 1px solid var(--accent, #7c3aed); color: #e5e7eb; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: 700; margin-top: 6px; }
        .admin-btn:hover { background: #171128; border-color: var(--accent-hover, #8b5cf6); }
        .admin-cv-section { margin-top: 32px; }
        .cv-download-form { display: flex; gap: 8px; }
        .cv-download-input { flex: 1; }
        #news-form-msg, #cv-msg { margin-top: 8px; font-size: 0.95em; }
        @media (max-width: 600px) {
            .admin-container { padding: 12px 2vw; }
            .admin-card { padding: 16px 6px; }
        }
    </style>
</head>
<body>
        <div id="admin-notification-bar" class="admin-notification-bar" style="display:none;"></div>
        <script>
        // Backend base helpers (shared with index.html semantics)
        function _normBase(u){ try { return String(u||'').trim().replace(/\/$/,''); } catch { return 'http://localhost:3001'; } }
        function getBackendBase(){
            try {
                const ls = localStorage.getItem('backendBase')||'';
                const ss = sessionStorage.getItem('backendBase')||'';
                return _normBase(ls||ss||'http://localhost:3001');
            } catch { return 'http://localhost:3001'; }
        }
        async function detectBackendBaseOnce(){
            const cands = [];
            try { const saved = (localStorage.getItem('backendBase')||'').trim(); if (saved) cands.push(saved); } catch {}
            cands.push('http://localhost:3001','http://localhost:3002');
            const uniq = [...new Set(cands.map(_normBase))];
            for (const b of uniq){
                try { const r = await fetch(_normBase(b)+'/health', { cache:'no-store' }); if (r.ok){ try{ sessionStorage.setItem('backendBase', _normBase(b)); }catch{} return _normBase(b); } } catch {}
            }
            return _normBase(uniq[0]);
        }
        // Uptime helpers voor label "server sinds"
        function __fmtDur(ms){
            try{
                ms = Math.max(0, ms|0);
                const s = Math.floor(ms/1000);
                const d = Math.floor(s/86400);
                const h = Math.floor((s%86400)/3600);
                const m = Math.floor((s%3600)/60);
                const sec = s%60;
                if (d>0) return `${d}d ${h}u ${m}m`;
                if (h>0) return `${h}u ${m}m ${sec}s`;
                if (m>0) return `${m}m ${sec}s`;
                return `${sec}s`;
            }catch{ return '‚Äî'; }
        }
        let __startedAtMs = 0;
        function __tickUptime(){
            try{
                const el = document.getElementById('admin-server-uptime');
                if (!el) return;
                if (!__startedAtMs){ el.textContent = 'server sinds: ‚Äî'; return; }
                el.textContent = 'server sinds: ' + __fmtDur(Date.now() - __startedAtMs);
            }catch{}
        }
        setInterval(__tickUptime, 1000);

        async function updateAdminBackendChips(){
            const chip = document.getElementById('admin-backend-chip');
            const baseEl = document.getElementById('admin-backend-base');
            const upEl = document.getElementById('admin-server-uptime');
            const base = await detectBackendBaseOnce();
            if (baseEl) baseEl.textContent = 'base: ' + base;
            if (!chip) return;
            try {
                const r = await fetch(base.replace(/\/$/,'') + '/health', { cache:'no-store' });
                if (r.ok){
                    chip.textContent = 'backend: online'; chip.style.color = '#22c55e'; chip.style.borderColor = '#195b37';
                    try { const j = await r.json(); if (j && j.startedAt){ __startedAtMs = new Date(j.startedAt).getTime() || 0; __tickUptime(); } } catch{}
                } else {
                    chip.textContent = 'backend: offline'; chip.style.color = '#ef4444'; chip.style.borderColor = '#5b1d1d'; if (upEl) upEl.textContent = 'server sinds: ‚Äî';
                }
            } catch {
                chip.textContent = 'backend: offline'; chip.style.color = '#ef4444'; chip.style.borderColor = '#5b1d1d'; if (upEl) upEl.textContent = 'server sinds: ‚Äî';
            }
        }
        </script>
    <script>
    // Zorg dat admin status uit localStorage wordt gelezen
    window.isAdmin = localStorage.getItem('isAdmin') === 'true';
    </script>
        <div class="admin-container">
            <!-- Tabs Layout (standaard) -->
            <div id="admin-tabs-layout" class="admin-tabs-layout">
                <div class="admin-card">
                    <button id="admin-logout-btn" class="admin-btn admin-logout-btn">Uitloggen</button>
                    <div class="admin-title" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">Admin Paneel (Tabs)
                        <span id="admin-backend-chip" style="border:1px solid #333;border-radius:8px;padding:2px 8px;color:#9ca3af;font-size:12px">backend: ‚Äî</span>
                        <span id="admin-backend-base" style="border:1px solid #333;border-radius:8px;padding:2px 8px;color:#9ca3af;font-size:12px">base: ‚Äî</span>
                        <span id="admin-server-uptime" style="border:1px solid #333;border-radius:8px;padding:2px 8px;color:#9ca3af;font-size:12px">server sinds: ‚Äî</span>
                        <button id="test-knop-geel" class="admin-btn" style="background:#fde047;color:#181828;border:2px solid #facc15;font-weight:900;">TEST KNOP GEEL</button>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 6px;align-items:center;">
                        <button id="run-workflow-btn" class="admin-btn">‚ñ∂Ô∏è Run backup workflow</button>
                        <a href="logs.html" class="admin-btn">üìä Open logboek</a>
                        <button class="admin-btn" type="button" onclick="GHDispatch.open('ci')">‚ñ∂ CI (live)</button>
                        <button id="open-news-tab-btn" class="admin-btn" type="button">üì∞ Nieuwsbeheer</button>
                        <a href="explorer-demo.html" class="admin-btn">üóÇÔ∏è Nieuwe Explorer</a>
                        <a href="scripts.html" class="admin-btn">üß∞ Script runner</a>
                        <a href="index.html" class="admin-btn">üè† Naar Home</a>
                        <span id="workflow-status" style="font-size:12px;color:#9ca3af;margin-left:6px;"></span>
                        <button id="check-upload-btn" class="admin-btn" type="button">üß™ Check upload</button>
                        <button id="restart-backend-btn" class="admin-btn" type="button">‚ôªÔ∏è Restart backend</button>
                        <button id="start-help-btn" class="admin-btn" type="button">‚ùì Start-hulp</button>
                    </div>
                    <div id="upload-check-output" class="admin-demo-muted" style="white-space:pre-wrap;margin-top:6px;"></div>
                    <script>
                    (function(){
                        const btn = document.getElementById('run-workflow-btn');
                        const out = document.getElementById('workflow-status');
                        if (!btn) return;
                        // Health check on load
                        (async ()=>{
                            try {
                                const base = await detectBackendBaseOnce();
                                const ctrl = new AbortController();
                                const t = setTimeout(()=>ctrl.abort(), 4000);
                                const r = await fetch(base.replace(/\/$/,'') + '/health', { signal: ctrl.signal });
                                clearTimeout(t);
                                if (!r.ok) throw new Error('HTTP '+r.status);
                                btn.disabled = false; out.style.color = '#22c55e'; out.textContent = 'Backend online ‚Ä¢ '+base;
                            } catch {
                                btn.disabled = true; out.style.color = '#ef4444'; out.textContent = 'Backend offline';
                            }
                            try { updateAdminBackendChips(); } catch {}
                        })();
                        btn.addEventListener('click', async ()=>{
                            out.style.color = '#9ca3af';
                            out.textContent = 'Workflow starten‚Ä¶';
                            try {
                                const ctrl = new AbortController();
                                const t = setTimeout(()=>ctrl.abort(), 120000);
                                const base = await detectBackendBaseOnce();
                                const res = await fetch(base.replace(/\/$/,'') + '/workflow/run', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ quick:true }), signal: ctrl.signal
                                });
                                clearTimeout(t);
                                if (!res.ok) throw new Error('HTTP '+res.status);
                                const j = await res.json();
                                out.style.color = '#22c55e';
                                out.textContent = 'Klaar. Exit: '+(j.exitCode ?? '0')+' ‚Ä¢ '+getBackendBase();
                                // Toon een kleine knop om direct het logboek te bekijken
                                try{
                                    let link = document.getElementById('view-backup-link');
                                    if (!link){
                                        link = document.createElement('a');
                                        link.id = 'view-backup-link';
                                        link.className = 'admin-btn';
                                        link.style.marginLeft = '8px';
                                        link.textContent = 'üìä View backup';
                                        btn.parentElement.appendChild(link);
                                    }
                                    link.href = 'logs.html?v=' + Date.now();
                                }catch{}
                                console.log('Workflow result', j);
                                alert('Workflow klaar. Zie logs.html voor details.');
                            } catch(e){
                                out.style.color = '#ef4444';
                                out.textContent = 'Fout: '+(e.message || e);
                            }
                        });
                                                // Upload check (toon user/repo/branch/scopes/permissions + advies)
                        const chk = document.getElementById('check-upload-btn');
                        const outEl = document.getElementById('upload-check-output');
                        if (chk) chk.addEventListener('click', async ()=>{
                                                        if (outEl){ outEl.style.whiteSpace = 'normal'; outEl.innerHTML = '<em>Controleren‚Ä¶</em>'; }
                            try{
                                const base = await detectBackendBaseOnce();
                                                                const r = await fetch(base.replace(/\/$/,'') + '/upload/check', { cache:'no-store' });
                                                                const j = await r.json().catch(()=>({}));

                                                                const user = j && j.user ? (j.user.login || j.user.id || '-') : '-';
                                                                const repoFull = j && j.repo ? (j.repo.full_name || '-') : '-';
                                                                const branch = j && j.branch ? (j.branch.name || '-') : '-';
                                                                const perms = (j && j.repo && j.repo.permissions) ? j.repo.permissions : {};
                                                                const canPush = !!(perms && (perms.push || perms.admin));
                                                                const scopes = j && j.token ? (j.token.scopes || null) : null;
                                                                const advice = j && j.advice ? j.advice : (canPush ? 'Token lijkt voldoende rechten te hebben.' : 'Token mist push (write) rechten. Maak een token met "Contents: Read and write" of gebruik een classic token met "repo".');

                                                                const statusColor = canPush ? '#22c55e' : '#ef4444';
                                                                const statusText = canPush ? 'Gereed voor uploads' : 'Geen schrijfrechten';
                                                                const scopeNote = scopes ? String(scopes) : '‚Äî (bij fine‚Äëgrained tokens staat dit soms leeg)';

                                                                const detailsJson = `<details style="margin-top:8px;"><summary style="cursor:pointer;color:#9ca3af">Ruwe respons</summary><pre style="background:#0b0b0b;border:1px solid #222;border-radius:8px;padding:8px;color:#d1d5db;overflow:auto;font-size:12px;white-space:pre;">${
                                                                        (()=>{ try { return JSON.stringify(j, null, 2).replace(/[<>&]/g, m=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[m])); } catch { return '‚Äî'; } })()
                                                                }</pre></details>`;

                                                                const html = `
                                                                        <div style="display:grid;gap:8px;">
                                                                            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                                                                                <span style="border:1px solid #333;border-radius:999px;padding:2px 10px;color:${statusColor};">${statusText}</span>
                                                                                <span style="border:1px solid #333;border-radius:999px;padding:2px 10px;color:#9ca3af;">base: ${base}</span>
                                                                            </div>
                                                                            <div style="display:grid;gap:6px;background:#0b0b0b;border:1px solid #222;border-radius:8px;padding:10px;">
                                                                                <div><b>üë§ User</b>: <span style="color:#e5e7eb;">${user}</span></div>
                                                                                <div><b>üì¶ Repo</b>: <span style="color:#e5e7eb;">${repoFull}</span></div>
                                                                                <div><b>üåø Branch</b>: <span style="color:#e5e7eb;">${branch}</span> ${j && j.branch && j.branch.exists===false ? '<span style="color:#ef4444">(bestaat niet)</span>' : ''}</div>
                                                                                <div><b>üîê Rechten</b>: push=${canPush?'true':'false'} ¬∑ admin=${perms && perms.admin?'true':'false'} ¬∑ pull=${perms && perms.pull?'true':'false'}</div>
                                                                                <div><b>üé´ Token scopes</b>: <span style="color:#cbd5e1;">${scopeNote}</span></div>
                                                                            </div>
                                                                            <div style="color:${canPush?'#22c55e':'#f59e0b'};">üí° ${advice}</div>
                                                                            ${canPush ? '' : '<div style="font-size:12px;color:#9ca3af;">Tip: Zet in <code>upload-backend/.env</code> GITHUB_TOKEN met (fine‚Äëgrained) Toegang ‚ÄúContents: Read and write‚Äù voor deze repo. Herstart daarna de backend.</div>'}
                                                                            ${detailsJson}
                                                                        </div>`;

                                                                if (outEl){ outEl.innerHTML = html; }
                                try{ updateAdminBackendChips(); }catch{}
                            } catch(e){ if (outEl){ outEl.textContent = '‚ùå '+(e.message||e); } }
                        });
                        // Restart backend
                        const rst = document.getElementById('restart-backend-btn');
                        if (rst) rst.addEventListener('click', async ()=>{
                            rst.disabled = true;
                            try{
                                const base = await detectBackendBaseOnce();
                                const r = await fetch(base.replace(/\/$/,'') + '/admin/restart', { method:'POST' });
                                const j = await r.json().catch(()=>({}));
                                alert('Herstart aangevraagd. Backend zal binnen enkele seconden opnieuw opstarten.');
                                // Poll health a few times to confirm
                                const poll = async ()=>{
                                    try{ const h = await fetch(base.replace(/\/$/,'') + '/health', { cache:'no-store' }); if (h.ok){ updateAdminBackendChips(); return true; } }catch{}
                                    return false;
                                };
                                let ok = false; for (let i=0;i<6;i++){ ok = await poll(); if (ok) break; await new Promise(r=>setTimeout(r, 1500)); }
                                if (!ok) alert('Let op: kon backend nog niet confirmeren. Ververs pagina na 5-10s.');
                            } catch(e){ alert('Restart mislukt: '+(e.message||e)); }
                            finally{ rst.disabled = false; }
                        });

                        // Start-hulp overlay
                        const startHelpBtn = document.getElementById('start-help-btn');
                        if (startHelpBtn) startHelpBtn.addEventListener('click', ()=>{
                            try{
                                const overlay = document.createElement('div');
                                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;z-index:9999;';
                                const box = document.createElement('div');
                                box.style.cssText = 'background:#111;border:1px solid #333;color:#e5e7eb;border-radius:12px;max-width:720px;width:92vw;max-height:84vh;overflow:auto;';
                                box.innerHTML = `
                                    <div style="padding:14px 16px;background:linear-gradient(135deg,#7c3aed,#2563eb);border-radius:12px 12px 0 0;display:flex;align-items:center;justify-content:space-between;color:#fff">
                                        <div style="font-weight:800">Start-hulp: Upload-backend (lokaal)</div>
                                        <button style="background:rgba(255,255,255,.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer">‚úï</button>
                                    </div>
                                    <div style="padding:14px;display:grid;gap:10px;font-size:14px;line-height:1.45;">
                                        <div>Deze lamp/base slaan op de lokale Node backend (uploads, nieuws, logs, workflow). Supabase staat hier los van.</div>
                                        <ol style="margin:0 0 0 18px;">
                                            <li>Open deze workspace in VS Code.</li>
                                            <li>Start taak: <b>Start Backend</b> (draait op 3001 of 3002).</li>
                                            <li>Of PowerShell:
                                                <div style="background:#0b0b0b;border:1px solid #333;border-radius:8px;padding:8px;margin-top:6px;font-family:ui-monospace,Consolas,monospace;font-size:12px;white-space:pre;">cd upload-backend
npm install
node index.js</div>
                                            </li>
                                            <li>Controleer <code>upload-backend/.env</code> (GITHUB_TOKEN, GITHUB_REPO, evt. PORT=3002).</li>
                                            <li>Terug hier: klik ‚ÄúAuto-detect‚Äù of stel base in; lampje moet ‚Äúonline‚Äù.</li>
                                        </ol>
                                    </div>`;
                                overlay.appendChild(box);
                                overlay.addEventListener('click', (e)=>{ if (e.target===overlay) overlay.remove(); });
                                const closeBtn = box.querySelector('button'); if (closeBtn) closeBtn.addEventListener('click', ()=>overlay.remove());
                                document.body.appendChild(overlay);
                            } catch(e){ alert('Kon start-hulp niet openen: '+(e.message||e)); }
                        });
                        // Quick-jump naar Nieuws tab
                        const openNewsBtn = document.getElementById('open-news-tab-btn');
                        if (openNewsBtn) {
                            openNewsBtn.addEventListener('click', ()=>{
                                const newsTabBtn = document.querySelector('.admin-tab-demo[data-tab="news"]');
                                if (newsTabBtn) newsTabBtn.click();
                            });
                        }
                    })();
                    </script>
        <!-- JS code moved to <script> below -->
                    <div class="admin-tabs-demo">
                        <button class="admin-tab-demo active" data-tab="news">Nieuws</button>
                        <button class="admin-tab-demo" data-tab="users">Gebruikersbeheer</button>
                        <button class="admin-tab-demo" data-tab="limits">Uploadlimieten</button>
                        <button class="admin-tab-demo" data-tab="cv">CV</button>
                        <button class="admin-tab-demo" data-tab="files">Bestanden</button>
                    <!-- Bestanden tab -->
                    <div class="admin-tab-content-demo tab-files" id="tab-files" style="display:none;">
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Bestandenbeheer (Supabase)</h3>
                            <div style="margin-bottom:12px;">
                                <label class="admin-label" for="file-upload-map">Categorie</label>
                                <select id="file-upload-map" class="admin-input" style="max-width:220px;display:inline-block;">
                                    <option value="">Alle bestanden (root)</option>
                                    <option value="system-tools">Systeem Tools</option>
                                    <option value="netwerk-tools">Netwerk Utils</option>
                                    <option value="security-tools">Security Pack</option>
                                    <option value="archives">Archives</option>
                                    <option value="admin-tools">Admin Tools</option>
                                    <option value="helpdesk-tools">Helpdesk Tools</option>
                                    <option value="overig">Overig</option>
                                </select>
                                <input type="file" id="uploadInputAdmin" class="admin-input" style="max-width:220px;display:inline-block;" />
                                <button id="uploadBtnAdmin" class="admin-btn" style="margin-left:8px;">‚¨ÜÔ∏è Upload</button>
                            </div>
                            <div id="fileListAdmin" class="explorer-content" style="display:grid;grid-template-columns:repeat(3,1fr);gap:18px;"></div>
                        </div>
                        <script type="module">
                        import { supabase } from './js/supabase-client.js';
                        let filesAdmin = [];
                        let selectedFileIndexAdmin = null;
                        let currentFolderAdmin = '';

                        async function fetchFilesAdmin() {
                            const folder = document.getElementById('file-upload-map').value;
                            currentFolderAdmin = folder;
                            const { data, error } = await supabase.storage.from('Bestanden').list(folder, { limit: 100 });
                            if (error) {
                                alert('Fout bij ophalen bestanden: ' + error.message);
                                return;
                            }
                            filesAdmin = (data || []).map(f => ({
                                name: f.name,
                                size: f.metadata && f.metadata.size ? (f.metadata.size/1024).toFixed(1) + ' KB' : '',
                                icon: 'üìÑ',
                                folder: folder
                            }));
                            renderFileListAdmin();
                        }

                        function renderFileListAdmin() {
                            const fileList = document.getElementById('fileListAdmin');
                            fileList.innerHTML = '';
                            filesAdmin.forEach((file, idx) => {
                                const div = document.createElement('div');
                                div.style.background = '#23234a';
                                div.style.borderRadius = '8px';
                                div.style.padding = '18px';
                                div.style.color = '#fff';
                                div.style.textAlign = 'center';
                                div.style.cursor = 'pointer';
                                div.style.border = selectedFileIndexAdmin === idx ? '2px solid #22c55e' : '2px solid transparent';
                                div.onclick = () => { selectedFileIndexAdmin = idx; renderFileListAdmin(); };
                                div.innerHTML = `
                                    <div style="font-size:32px;">${file.icon}</div>
                                    <div style="font-weight:600; margin-top:8px;">${file.name}</div>
                                    <div class="file-size" style="color:#38bdf8;">${file.size}</div>
                                    <div style="font-size:12px; color:#22c55e; margin-top:6px;">${selectedFileIndexAdmin === idx ? 'Geselecteerd' : ''}</div>
                                    <button style="margin-top:10px;" onclick="event.stopPropagation();downloadSelectedFileAdmin(${idx})">‚¨áÔ∏è Download</button>
                                `;
                                fileList.appendChild(div);
                            });
                        }

                        window.downloadSelectedFileAdmin = async function(idx) {
                            const file = filesAdmin[idx];
                            const supabasePath = (file.folder ? file.folder + '/' : '') + file.name;
                            const publicUrlObj = supabase.storage.from('Bestanden').getPublicUrl(supabasePath);
                            let publicUrl = '';
                            if (publicUrlObj.publicUrl) {
                                publicUrl = publicUrlObj.publicUrl;
                            } else if (publicUrlObj.data && publicUrlObj.data.publicUrl) {
                                publicUrl = publicUrlObj.data.publicUrl;
                            }
                            if (publicUrl && publicUrl.startsWith('http')) {
                                window.open(publicUrl, '_blank');
                            } else {
                                alert('Download URL niet gevonden of bestand is niet publiek. Controleer bucket-instellingen in Supabase.');
                            }
                        }

                        document.getElementById('uploadBtnAdmin').onclick = async function() {
                            const fileInput = document.getElementById('uploadInputAdmin');
                            const folder = document.getElementById('file-upload-map').value;
                            const file = fileInput.files[0];
                            if (!file) { alert('Selecteer een bestand.'); return; }
                            const path = folder ? folder + '/' + file.name : file.name;
                            const { data, error } = await supabase.storage.from('Bestanden').upload(path, file, { upsert: true });
                            if (error) {
                                alert('Upload fout: ' + error.message);
                            } else {
                                alert('Upload gelukt: ' + file.name);
                                fetchFilesAdmin();
                            }
                            fileInput.value = '';
                        };

                        document.getElementById('file-upload-map').onchange = function() {
                            fetchFilesAdmin();
                        };

                        fetchFilesAdmin();
                        </script>
                    </div>
                        <button class="admin-tab-demo" data-tab="sitebeheer">Sitebeheer</button>
                        <button class="admin-tab-demo" data-tab="logboek">Logboek</button>
                        <button class="admin-tab-demo" data-tab="settings">Instellingen</button>
                    <!-- Uploadlimieten tab -->
                        <div class="admin-tab-content-demo tab-limits" id="tab-limits" style="display:none;">
                            <div class="admin-widget">
                                <h3 class="admin-widget-title">Uploadlimieten instellen</h3>
                                <div class="admin-demo-muted">(Demo: alleen UI, geen backend)</div>
                                <form id="upload-limits-form" class="admin-form">
                                    <label class="admin-label" for="limit-cv">CV (PDF)</label>
                                    <input class="admin-input" type="number" id="limit-cv" min="1" max="50" value="5" required placeholder="Max uploads per dag">
                                    <label class="admin-label" for="limit-tools">System Tools</label>
                                    <input class="admin-input" type="number" id="limit-tools" min="1" max="50" value="10" required placeholder="Max uploads per dag">
                                    <label class="admin-label" for="limit-network">Network Utils</label>
                                    <input class="admin-input" type="number" id="limit-network" min="1" max="50" value="10" required placeholder="Max uploads per dag">
                                    <label class="admin-label" for="limit-security">Security Pack</label>
                                    <input class="admin-input" type="number" id="limit-security" min="1" max="50" value="5" required placeholder="Max uploads per dag">
                                    <label class="admin-label" for="limit-archives">Archives</label>
                                    <input class="admin-input" type="number" id="limit-archives" min="1" max="50" value="5" required placeholder="Max uploads per dag">
                                    <label class="admin-label" for="limit-games">Games</label>
                                    <input class="admin-input" type="number" id="limit-games" min="1" max="50" value="5" required placeholder="Max uploads per dag">
                                    <button class="admin-btn" type="submit">Opslaan</button>
                                    <div id="upload-limits-msg" class="admin-form-msg"></div>
                                </form>
                            </div>
                        </div>
                    <!-- Gebruikersbeheer tab -->
                    <div class="admin-tab-content-demo tab-users" id="tab-users" style="display:none;">
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Gebruikersbeheer</h3>
                            <div class="admin-demo-muted">(Demo: alleen UI, geen backend)</div>
                            <h4 class="admin-widget-subtitle">Admins</h4>
                            <ul id="admin-list-demo" class="admin-list">
                                <li>admin (jij)</li>
                                <li>beheerder2</li>
                            </ul>
                        </div>
                        <div class="admin-widget">
                            <h4 class="admin-widget-subtitle">Wachtwoord wijzigen</h4>
                            <form id="change-password-form" class="admin-form">
                                <label class="admin-label" for="current-password">Huidig wachtwoord</label>
                                <input class="admin-input" type="password" id="current-password" required placeholder="Huidig wachtwoord">
                                <label class="admin-label" for="new-password">Nieuw wachtwoord</label>
                                <input class="admin-input" type="password" id="new-password" required placeholder="Nieuw wachtwoord">
                                <label class="admin-label" for="confirm-password">Bevestig nieuw wachtwoord</label>
                                <input class="admin-input" type="password" id="confirm-password" required placeholder="Bevestig nieuw wachtwoord">
                                <button class="admin-btn" type="submit">Wijzigen</button>
                                <div id="change-password-msg" class="admin-form-msg"></div>
                            </form>
                        </div>
                        <div class="admin-widget">
                            <h4 class="admin-widget-subtitle">Nieuwe admin toevoegen</h4>
                            <form id="add-admin-form" class="admin-form">
                                <label class="admin-label" for="new-admin-name">Gebruikersnaam</label>
                                <input class="admin-input" type="text" id="new-admin-name" required placeholder="Gebruikersnaam">
                                <label class="admin-label" for="new-admin-password">Wachtwoord</label>
                                <input class="admin-input" type="password" id="new-admin-password" required placeholder="Wachtwoord">
                                <button class="admin-btn" type="submit">Toevoegen</button>
                                <div id="add-admin-msg" class="admin-form-msg"></div>
                            </form>
                        </div>
                    </div>
                        <div class="admin-tab-content-demo tab-logboek" id="tab-logboek" style="display:none;">
                            <div class="admin-widget">
                                <h3 class="admin-widget-title">Activiteitenlogboek</h3>
                                <div id="logboek-list" class="logboek-list">
                                    <div class="logboek-empty">Logboek wordt geladen...</div>
                                </div>
                                <button class="admin-btn logboek-clear-btn" type="button" onclick="clearLogboek()">Logboek wissen</button>
                            </div>
                        </div>
                        <script>
                        // Activiteitenlogboek (localStorage)
                        function addLogboekEntry(action) {
                            const logs = JSON.parse(localStorage.getItem('adminLogboek') || '[]');
                            logs.unshift({
                                tijd: new Date().toLocaleString(),
                                actie: action,
                                agent: navigator.userAgent
                            });
                            localStorage.setItem('adminLogboek', JSON.stringify(logs.slice(0, 100)));
                            renderLogboek();
                        }

                        function renderLogboek() {
                            const logs = JSON.parse(localStorage.getItem('adminLogboek') || '[]');
                            const list = document.getElementById('logboek-list');
                            if (!list) return;
                            if (logs.length === 0) {
                                list.innerHTML = '<div class="logboek-empty">Geen activiteiten gelogd.</div>';
                                return;
                            }
                            list.innerHTML = logs.map(log =>
                                `<div class='logboek-item'>
                                    <span class='logboek-tijd'>${log.tijd}</span> ‚Äî <b>${log.actie}</b><br>
                                    <span class='logboek-agent'>${log.agent}</span>
                                </div>`
                            ).join('');
                        }

                        function clearLogboek() {
                            if (confirm('Weet je zeker dat je het logboek wilt wissen?')) {
                                localStorage.removeItem('adminLogboek');
                                renderLogboek();
                                showAdminNotification('Logboek gewist.', 'info');
                            }
                        }

                        // Log standaard admin acties (voorbeeld)
                        document.addEventListener('DOMContentLoaded', function() {
                            renderLogboek();
                            addLogboekEntry('Adminpaneel geopend');
                        });
                        </script>
                    <div class="admin-tab-content-demo tab-sitebeheer" id="tab-sitebeheer" style="display:none;">
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Statistieken per categorie</h3>
                            <table class="sitebeheer-table">
                                <thead>
                                    <tr>
                                        <th>Categorie</th>
                                        <th>Aantal downloads</th>
                                        <th>Laatst gedownload</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td>CV</td><td id="stat-cv">3</td><td id="stat-cv-last">2025-10-29 21:12</td></tr>
                                    <tr><td>System Tools</td><td id="stat-tools">7</td><td id="stat-tools-last">2025-10-30 09:44</td></tr>
                                    <tr><td>Network Utils</td><td id="stat-network">2</td><td id="stat-network-last">2025-10-28 16:02</td></tr>
                                    <tr><td>Security Pack</td><td id="stat-security">1</td><td id="stat-security-last">2025-10-27 13:55</td></tr>
                                    <tr><td>Archives</td><td id="stat-archives">0</td><td id="stat-archives-last">-</td></tr>
                                    <tr><td>Games</td><td id="stat-games">4</td><td id="stat-games-last">2025-10-29 18:20</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Bezoekersstatistieken</h3>
                            <div class="sitebeheer-visitors">Totaal unieke bezoekers: <span id="stat-visitors">42</span></div>
                            <div class="sitebeheer-lastvisit">Laatste bezoek: <span id="stat-last-visit">2025-10-30 10:01</span></div>
                        </div>
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Totaal aantal downloads</h3>
                            <div class="sitebeheer-totaldownloads">17</div>
                        </div>
                        <div class="admin-demo-muted">(Demo: cijfers zijn voorbeelddata, klaar voor backend-koppeling)</div>
                    </div>
                    </div>
                    <div class="admin-tab-content-demo tab-news active" id="tab-news">
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Nieuws toevoegen</h3>
                            <form id="news-admin-form" class="admin-form">
                                <label class="admin-label" for="news-title">Titel</label>
                                <input class="admin-input" type="text" id="news-title" required>
                                <label class="admin-label" for="news-content">Bericht</label>
                                <textarea class="admin-textarea" id="news-content" required></textarea>
                                <label class="admin-label" for="news-link">Link (optioneel)</label>
                                <input class="admin-input" type="text" id="news-link">
                                <button class="admin-btn admin-form-btn" type="submit">Toevoegen</button>
                                <div id="news-form-msg" class="admin-form-msg"></div>
                            </form>
                        </div>
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">Geplaatste nieuwsberichten (demo)</h3>
                            <ul id="news-list-admin" class="news-list-demo admin-list"></ul>
                        </div>
                    </div>
                    <div class="admin-tab-content-demo tab-cv" id="tab-cv">
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">CV uploaden (alleen admin)</h3>
                                <form id="cv-upload-form" class="cv-upload-demo">
                                    <label for="cv-upload-input" class="admin-label">Selecteer CV-bestand (PDF, DOC, DOCX)</label>
                                    <input type="file" id="cv-upload-input" accept=".pdf,.doc,.docx" class="admin-input" required placeholder="Kies je CV-bestand">
                                    <button type="submit" class="admin-btn">Uploaden</button>
                                </form>
                                <div id="cv-upload-msg" class="admin-demo-muted"></div>
                                <script type="module">
                                import { supabase } from './js/supabase-client.js';
                                document.getElementById('cv-upload-form').onsubmit = async function(e) {
                                    e.preventDefault();
                                    const input = document.getElementById('cv-upload-input');
                                    const msg = document.getElementById('cv-upload-msg');
                                    if (!input.files.length) { msg.textContent = 'Selecteer een bestand.'; msg.style.color = '#ef4444'; return; }
                                    const file = input.files[0];
                                    msg.textContent = 'Uploaden...'; msg.style.color = '#9ca3af';
                                    const { data, error } = await supabase.storage.from('CV').upload(file.name, file, { upsert: true });
                                    if (error) {
                                        msg.textContent = 'Fout bij uploaden: ' + error.message;
                                        msg.style.color = '#ef4444';
                                    } else {
                                        msg.textContent = 'Upload gelukt: ' + file.name;
                                        msg.style.color = '#22c55e';
                                        input.value = '';
                                    }
                                };
                                </script>
                        </div>
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">CV bekijken & downloaden</h3>
                            <div class="cv-admin-info">Alleen PDF beschikbaar voor privacy.</div>
                            <form id="cv-upload-form-pdf" style="margin-bottom:10px;">
                                <label for="cv-upload-input-pdf" class="admin-label">Upload PDF</label>
                                <input type="file" id="cv-upload-input-pdf" accept=".pdf" class="admin-input" required placeholder="Kies PDF-bestand">
                                <button type="submit" class="admin-btn">Upload PDF</button>
                                <div id="cv-upload-msg-pdf" class="admin-form-msg"></div>
                            </form>
                            <form id="cv-upload-form-word" style="margin-bottom:10px;">
                                <label for="cv-upload-input-word" class="admin-label">Upload Word (.doc/.docx)</label>
                                <input type="file" id="cv-upload-input-word" accept=".doc,.docx" class="admin-input" required placeholder="Kies Word-bestand">
                                <button type="submit" class="admin-btn">Upload Word</button>
                                <div id="cv-upload-msg-word" class="admin-form-msg"></div>
                            </form>
                            <script type="module">
                            import { supabase } from './js/supabase-client.js';
                            document.getElementById('cv-upload-form-pdf').onsubmit = async function(e) {
                                e.preventDefault();
                                const input = document.getElementById('cv-upload-input-pdf');
                                const msg = document.getElementById('cv-upload-msg-pdf');
                                if (!input.files.length) { msg.textContent = 'Selecteer een PDF-bestand.'; msg.style.color = '#ef4444'; return; }
                                const file = input.files[0];
                                msg.textContent = 'Uploaden...'; msg.style.color = '#9ca3af';
                                const { data, error } = await supabase.storage.from('CV').upload(file.name, file, { upsert: true });
                                if (error) {
                                    msg.textContent = 'Fout bij uploaden: ' + error.message;
                                    msg.style.color = '#ef4444';
                                } else {
                                    msg.textContent = 'Upload gelukt: ' + file.name;
                                    msg.style.color = '#22c55e';
                                    input.value = '';
                                }
                            };
                            document.getElementById('cv-upload-form-word').onsubmit = async function(e) {
                                e.preventDefault();
                                const input = document.getElementById('cv-upload-input-word');
                                const msg = document.getElementById('cv-upload-msg-word');
                                if (!input.files.length) { msg.textContent = 'Selecteer een Word-bestand.'; msg.style.color = '#ef4444'; return; }
                                const file = input.files[0];
                                msg.textContent = 'Uploaden...'; msg.style.color = '#9ca3af';
                                const { data, error } = await supabase.storage.from('CV').upload(file.name, file, { upsert: true });
                                if (error) {
                                    msg.textContent = 'Fout bij uploaden: ' + error.message;
                                    msg.style.color = '#ef4444';
                                } else {
                                    msg.textContent = 'Upload gelukt: ' + file.name;
                                    msg.style.color = '#22c55e';
                                    input.value = '';
                                }
                            };
                            </script>
                        </div>
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">CV-bestanden beheren</h3>
                            <div class="admin-demo-muted">(Demo: alleen UI, geen backend)</div>
                            <ul id="cv-file-list" class="admin-list">
                                <!-- Dynamisch gevuld door JS -->
                            </ul>
                            <div id="cv-file-msg" class="admin-form-msg"></div>
                        </div>
                        <div class="admin-widget">
                            <h3 class="admin-widget-title">CV Beheer (alleen admin)</h3>
                            <div class="cv-admin-desc">Bekijk of download je CV in Word of PDF formaat. Klik op een knop voor een voorbeeld en downloadopties.</div>
                            <div class="cv-admin-btn-row">
                                <button class="admin-btn" type="button" onclick="showCVPopup('pdf')">Bekijk CV (PDF)</button>
                                <button class="admin-btn" type="button" onclick="showCVPopup('docx')">Bekijk CV (Word)</button>
                            </div>
                            <div id="cv-admin-popup-tabs" class="cv-admin-popup">
                                <div id="cv-admin-popup-content-tabs" class="cv-admin-popup-content">
                                    <h3 id="cv-popup-title-tabs" class="cv-popup-title">CV Voorbeeld</h3>
                                    <div id="cv-preview-area-tabs" class="cv-preview-area"></div>
                                    <div class="cv-download-links">
                                        <a id="cv-download-link-pdf-tabs" href="cv/NEW CV 7-8.pdf" download class="cv-download-link">Download PDF</a>
                                        <a id="cv-download-link-docx-tabs" href="cv/NEW CV 7-8.docx" download class="cv-download-link">Download Word</a>
                                    </div>
                                    <button onclick="closeCVPopup()" class="cv-popup-close">Sluiten</button>
                                </div>
                            </div>
                        </div>
                        <div class="admin-widget">
                        </div>
                        <script>
                        // CV upload (demo) notificatie en logboek
                        document.getElementById('cv-upload-form').onsubmit = function(e) {
                            e.preventDefault();
                            showAdminNotification('CV upload (demo): bestand ontvangen!', 'success');
                            addLogboekEntry('CV upload (demo)');
                            document.getElementById('cv-upload-msg').textContent = 'Upload gesimuleerd!';
                            this.reset();
                        };
                        // Bestand upload (demo) notificatie en logboek
                        document.querySelectorAll('.file-upload-demo').forEach(form => {
                            form.onsubmit = function(e) {
                                e.preventDefault();
                                showAdminNotification('Bestand upload (demo): bestand ontvangen!', 'success');
                                addLogboekEntry('Bestand upload (demo)');
                                const msg = this.parentElement.querySelector('.admin-form-msg');
                                if(msg) msg.textContent = 'Upload gesimuleerd!';
                                this.reset();
                            };
                        });
                        </script>
                    </div>
        <!-- JS functionaliteit is alleen in <script> blokken, niet als tekst zichtbaar in de UI -->
</body>
    <!-- Removed duplicate upload/logout inline scripts; logic handled by ES module. -->
    <script>
    // Admin CV popup logic
    function showCVAdminPopup() {
        document.getElementById('cv-admin-popup').style.display = 'flex';
    }
    function closeCVAdminPopup() {
        document.getElementById('cv-admin-popup').style.display = 'none';
        document.getElementById('cv-admin-msg').textContent = '';
        document.getElementById('cv-admin-code').value = '';
    }
    function downloadCVAdmin() {
        const code = document.getElementById('cv-admin-code').value.trim();
        if (code === 'jouwcode') {
            window.open('cv/NEW CV 7-8.pdf', '_blank');
            closeCVAdminPopup();
        } else {
            document.getElementById('cv-admin-msg').textContent = 'Ongeldige code!';
        }
    }
    </script>

    <!-- Load tab navigation and Supabase integration (ES module) -->
    <script type="module" src="js/admin-tabs-supabase.js"></script>
        <script src="js/status-indicators.js"></script>
        <script>
            // 3) Centraliseer helpers: shim bestaande functies naar StatusIndicators
            window.getBackendBase = function(){ try{ return (window.StatusIndicators && StatusIndicators.getBase()) || (localStorage.getItem('backendBase')||'http://localhost:3002'); }catch{ return 'http://localhost:3002'; } }
            window.detectBackendBaseOnce = function(){ return (window.StatusIndicators && StatusIndicators.detectBaseOnce()) || Promise.resolve(window.getBackendBase()); }
            // LIVE banner tonen wanneer omgeving=live
            (function(){
                function updateLiveBanner(){
                    try{
                        var bar = document.getElementById('admin-notification-bar');
                        if (!bar) return;
                        var isLive = (window.StatusIndicators && StatusIndicators.getEnvMode && StatusIndicators.getEnvMode()==='live');
                        if (isLive){
                            bar.style.display = 'block';
                            bar.className = 'admin-notification-bar info';
                            bar.innerHTML = 'LIVE omgeving actief ‚Äî lokale workflow en scripts zijn uitgeschakeld. <a href="live-tools.html" style="color:#4ade80;text-decoration:underline">Open Live Tools</a>';
                        } else {
                            // verberg alleen als het door ons gezet is (niet bij error state)
                            if (bar.className.indexOf('error') === -1) { bar.style.display = 'none'; bar.textContent = ''; }
                        }
                    }catch{}
                }
                document.addEventListener('DOMContentLoaded', updateLiveBanner);
                setInterval(updateLiveBanner, 5000);
            })();
        </script>
        <style>
            /* 2) Vervang oude inline pills door de nieuwe dock: verberg de oude badges */
            #admin-backend-chip, #admin-backend-base { display:none !important; }
        </style>
    <script>
    window.addEventListener('error', function(e) {
        const bar = document.getElementById('admin-notification-bar');
        if (bar) {
            bar.style.display = 'block';
            bar.className = 'admin-notification-bar error';
            bar.textContent = 'Fout in admin script: ' + (e.message || e);
        }
        console.error('Admin script error:', e);
    });
    </script>
        <script>
        // Nieuwsbeheer: laad en plaats nieuws via backend /news
        (function(){
            const form = document.getElementById('news-admin-form');
            const msg = document.getElementById('news-form-msg');
            const list = document.getElementById('news-list-admin');

            async function tryFetch(url, opts, ms){
                const ctrl = new AbortController();
                const t = setTimeout(()=>ctrl.abort(), ms||4000);
                try{ const r = await fetch(url, { ...(opts||{}), signal: ctrl.signal }); clearTimeout(t); return r; }catch(e){ clearTimeout(t); return null; }
            }

            async function loadNews(){
                if (!list) return;
                list.innerHTML = '<li style="color:#9ca3af">Laden‚Ä¶</li>';
                let items = [];
                // 1) backend
                try{
                    const r = await tryFetch(getBackendBase().replace(/\/$/,'') + '/news', { headers:{'Accept':'application/json'} }, 3500);
                    if (r && r.ok){ items = await r.json(); }
                }catch{}
                // 2) static fallback
                if (!Array.isArray(items) || items.length===0){
                    try{ const r2 = await tryFetch('news.json?ts='+Date.now(), { headers:{'Accept':'application/json'} }, 3500); if (r2 && r2.ok) items = await r2.json(); }catch{}
                }
                items = Array.isArray(items)? items : [];
                if (items.length === 0){ list.innerHTML = '<li style="color:#9ca3af">Nog geen nieuws.</li>'; return; }
                list.innerHTML = items.map(n => '<li><b>'+((n.title||'').replace(/</g,'&lt;'))+'</b> <span style="color:#9ca3af">('+((n.date||'').replace(/</g,'&lt;'))+')</span><br><span style="font-size:12px;color:#cbd5e1">'+((n.content||'').replace(/</g,'&lt;'))+'</span></li>').join('');
            }

            async function submitNews(e){
                e && e.preventDefault();
                if (!form) return;
                const title = (document.getElementById('news-title')||{}).value||'';
                const content = (document.getElementById('news-content')||{}).value||'';
                const link = (document.getElementById('news-link')||{}).value||'';
                if (!title.trim() || !content.trim()){
                    if (msg){ msg.style.color = '#ef4444'; msg.textContent = 'Titel en bericht zijn verplicht.'; }
                    return;
                }
                if (msg){ msg.style.color = '#9ca3af'; msg.textContent = 'Plaatsen‚Ä¶'; }
                try{
                    const res = await tryFetch(getBackendBase().replace(/\/$/,'') + '/news', {
                        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, content, link, date: new Date().toISOString().slice(0,10) })
                    }, 5000);
                                if (res && res.ok){
                        if (msg){ msg.style.color = '#22c55e'; msg.textContent = 'Nieuws geplaatst.'; }
                        form.reset();
                        loadNews();
                                } else {
                                    if (msg){
                                        msg.style.color = '#ef4444';
                                        if (res && res.status === 404) {
                                            msg.textContent = 'Backend online maar /news endpoint ontbreekt. Herstart de upload-backend zodat de nieuwe routes actief zijn.';
                                        } else if (res) {
                                            msg.textContent = 'Backend gaf fout ('+res.status+'). Probeer opnieuw of herstart de upload-backend.';
                                        } else {
                                            msg.textContent = 'Backend niet bereikbaar ('+getBackendBase()+').';
                                        }
                                    }
                    }
                            }catch(err){ if (msg){ msg.style.color = '#ef4444'; msg.textContent = 'Fout bij plaatsen. Controleer backend en probeer opnieuw.'; } }
            }

            if (form){ form.addEventListener('submit', submitNews); }
            document.addEventListener('DOMContentLoaded', function(){ loadNews(); updateAdminBackendChips(); });
        })();
        </script>
</html>
